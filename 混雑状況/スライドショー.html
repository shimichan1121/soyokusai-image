<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文化祭 企画別混雑状況スライドショー</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* 基本となるスタイル（最も大きな画面サイズを想定） */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden; /* スクロールバーを非表示 */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* 画面全体に広がるように */
            background-color: #2c3e50; /* 暗めの背景色 */
            color: #ecf0f1; /* 明るい文字色 */
            transition: background-color 0.5s ease-in-out; /* 背景色切り替え時のアニメーション */
            font-size: 16px; /* 基準となるフォントサイズ */
        }

        .slide-container {
            width: 98%; /* 画面幅の98%に拡大 */
            height: 90vh; 
            max-width: 1920px; /* さらに大きな最大幅を設定 (例: フルHDの幅) */
            max-height: 900px; 
            
            background-color: rgba(44, 62, 80, 0.9); 
            border-radius: 25px; 
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5); 
            padding: 4vw; 
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-sizing: border-box; 
            transition: opacity 0.8s ease-in-out; 
            opacity: 0; 
        }
        
        .slide-container.active {
            opacity: 1; 
        }

        .slide-title {
            font-size: 5vw; 
            font-weight: 700;
            margin-bottom: 0.8em; 
            color: #f1c40f; 
            line-height: 1.2;
            word-break: break-word; 
            max-width: 90%; 
        }

        .slide-status {
            font-size: 3.5vw; 
            font-weight: 700;
            padding: 0.6em 1.2em; 
            border-radius: 1.2em; 
            margin-bottom: 0.8em; 
            display: inline-block;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out;
        }

        /* 混雑状況ごとの色（変更なし） */
        .status-実施していない { background-color: #95a5a6; color: #fdfdfd; }
        .status-待ち時間なし { background-color: #27ae60; color: #fdfdfd; }
        .status-10分未満 { background-color: #f39c12; color: #fdfdfd; }
        .status-10分以上 { background-color: #e74c3c; color: #fdfdfd; }
        .status-30分以上 { background-color: #8e44ad; color: #fdfdfd; }
        .status-売り切れ・終了 { background-color: #3498db; color: #fdfdfd; }

        .slide-comment {
            font-size: 2.5vw; 
            line-height: 1.6;
            margin-bottom: 0.6em; 
            white-space: pre-wrap;
            max-width: 85%;
            margin-left: auto;
            margin-right: auto;
            color: #bdc3c7;
        }

        .slide-details {
            font-size: 1.8vw; 
            color: #b0b4b8;
            margin-top: 1em; 
        }
        .slide-details span {
            margin: 0 0.8em; 
        }
        .slide-details strong {
            color: #ecf0f1;
        }

        .last-update-time {
            position: absolute;
            bottom: 2vh; 
            right: 2vw; 
            font-size: 1.2vw; 
            color: #bdc3c7;
            background-color: rgba(0, 0, 0, 0.4);
            padding: 0.6em 1em; 
            border-radius: 1em;
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9); 
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 4vw; 
            z-index: 9999;
        }

        /* スマートフォンなど、より小さい画面向けの調整 */
        @media (max-width: 768px) {
            .slide-container {
                padding: 5vw;
                height: 95vh; 
            }
            .slide-title {
                font-size: 8vw; 
            }
            .slide-status {
                font-size: 5vw;
                padding: 0.8em 1.5em;
            }
            .slide-comment {
                font-size: 3.5vw;
            }
            .slide-details {
                font-size: 2.5vw;
                flex-wrap: wrap; 
                justify-content: center; 
            }
            .slide-details span {
                margin: 0.5em 0.8em; 
            }
            .last-update-time {
                font-size: 2vw;
                padding: 0.5em 0.8em;
            }
            #loading {
                font-size: 6vw;
            }
        }

        /* 非常に大きな画面向けの調整（任意） */
        @media (min-width: 1920px) {
            body {
                font-size: 20px; 
            }
            .slide-title {
                font-size: 96px; 
            }
            .slide-status {
                font-size: 64px;
            }
            .slide-comment {
                font-size: 40px;
            }
            .slide-details {
                font-size: 32px;
            }
            .last-update-time {
                font-size: 24px;
            }
            #loading {
                font-size: 64px;
            }
        }
    </style>
</head>
<body>
    <div id="loading">情報を読み込み中...</div>

    <div id="slideshow-container">
        </div>

    <div class="last-update-time">最終更新: <span id="lastUpdateTime">--/-- --:--</span></div>

    <script>
        // Google Apps ScriptのウェブアプリURL
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwOm38pj-RhWN8VMvMM6vNW1t9mOoRkxNRKn7EanYyk7CqHBMngQZv7fUbskjCtgpzwLw/exec'; 

        let allEventsData = [];
        let currentSlideIndex = 0;
        const slideChangeDelay = 8000; // 各スライドの表示時間 (8秒)
        const fetchInterval = 5 * 60 * 1000; // データ更新間隔 (5分)
        let slideshowInterval; // スライド切り替え用インターバル
        let dataFetchInterval; // データ取得用インターバル

        // スライドショーのデータ取得と表示を開始
        async function startSlideshow() {
            await fetchAndRenderSlides(); // 最初のデータ取得と表示
            
            // データ取得を定期的に行う
            dataFetchInterval = setInterval(fetchAndRenderSlides, fetchInterval);
        }

        async function fetchAndRenderSlides() {
            const loadingElement = document.getElementById('loading');
            const slideshowContainer = document.getElementById('slideshow-container');
            const lastUpdateTimeElement = document.getElementById('lastUpdateTime');

            loadingElement.style.display = 'flex'; // ローディング表示

            try {
                const response = await fetch(GAS_WEB_APP_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const fetchedData = await response.json();

                // 企画名があるものをフィルタリング（「実施していない」も含むように変更）
                allEventsData = fetchedData.filter(item => 
                    item.企画名 && item.企画名.trim() !== ''
                );
                
                if (allEventsData.length === 0) {
                    slideshowContainer.innerHTML = '<div class="slide-container active"><div class="slide-title">現在、表示可能な企画はありません</div><div class="slide-comment">新しい情報をお待ちください。</div></div>';
                    loadingElement.style.display = 'none';
                    // データがない場合、スライドショーを停止
                    if (slideshowInterval) clearInterval(slideshowInterval);
                    return;
                }

                // 最終更新日時を計算して表示
                let latestUpdateTime = null;
                fetchedData.forEach(item => { // 全てのデータから最終更新日時を探す
                    const itemUpdateTime = item.更新 || item.更新時刻;
                    if (itemUpdateTime) {
                        const currentItemDate = new Date(itemUpdateTime);
                        if (!latestUpdateTime || currentItemDate > latestUpdateTime) {
                            latestUpdateTime = currentItemDate;
                        }
                    }
                });

                if (latestUpdateTime) {
                    lastUpdateTimeElement.textContent = latestUpdateTime.toLocaleString('ja-JP', { 
                        year: 'numeric', month: '2-digit', day: '2-digit', 
                        hour: '2-digit', minute: '2-digit' 
                    });
                }


                // スライドショーのインターバルをクリアして再設定
                if (slideshowInterval) {
                    clearInterval(slideshowInterval);
                }
                currentSlideIndex = 0; // データ更新時にスライドを最初に戻す

                // 最初のスライドを表示
                renderSlide(allEventsData[currentSlideIndex]);
                
                slideshowInterval = setInterval(() => {
                    currentSlideIndex = (currentSlideIndex + 1) % allEventsData.length;
                    renderSlide(allEventsData[currentSlideIndex]);
                }, slideChangeDelay);

            } catch (error) {
                console.error('スライドショーデータの取得に失敗しました:', error);
                slideshowContainer.innerHTML = '<div class="slide-container active"><div class="slide-title">エラーが発生しました</div><div class="slide-comment">情報を読み込めませんでした。</div></div>';
            } finally {
                loadingElement.style.display = 'none';
            }
        }

        function renderSlide(item) {
            const slideshowContainer = document.getElementById('slideshow-container');
            
            // 古いスライドにactiveクラスを付けてopacityアニメーションを適用
            const oldSlide = slideshowContainer.querySelector('.slide-container');
            if (oldSlide) {
                oldSlide.classList.remove('active');
                // アニメーション完了後に削除するために少し待つ
                setTimeout(() => {
                    if (oldSlide.parentNode) {
                        oldSlide.parentNode.removeChild(oldSlide);
                    }
                }, 800); // CSSのtransition時間よりも長く設定
            }

            // 場所(棟)の表示を調整
            let buildingDisplay = '';
            if (item['場所(棟)'] && item['場所(棟)'] !== '屋外') {
                buildingDisplay = `${item['場所(棟)']}棟`;
            }

            const slideDiv = document.createElement('div');
            slideDiv.classList.add('slide-container');

            slideDiv.innerHTML = `
                <div class="slide-title">${item.企画名 || '企画名なし'}</div>
                <div class="slide-status ${getStatusClass(item.状況)}">${item.状況 || '不明'}</div>
                ${item.コメント ? `<div class="slide-comment">${item.コメント}</div>` : ''}
                <div class="slide-details">
                    <span>${item.年 || ''}${item.年 ? '年' : ''}</span>
                    <span>${item.組 || ''}${item.組 ? '組' : ''}</span>
                    <span>${item.団体名 || ''}</span>
                    <span>${buildingDisplay} ${item['場所(階)'] || ''}${item['場所(階)'] ? '階' : ''}</span>
                    <span>${item.使用教室名 || ''}</span>
                    <span>${item.ジャンル || ''}</span>
                </div>
            `;
            
            slideshowContainer.appendChild(slideDiv);
            // 新しいスライドを表示するためにactiveクラスを追加
            setTimeout(() => {
                slideDiv.classList.add('active');
            }, 10); // 短い遅延を入れてtransitionをトリガー
        }

        // 状況に応じたCSSクラスを返すヘルパー関数 (既存のCSSクラス名と一致)
        function getStatusClass(status) {
            switch (status) {
                case '実施していない': return 'status-実施していない';
                case '待ち時間なし': return 'status-待ち時間なし';
                case '10分未満': return 'status-10分未満';
                case '10分以上': return 'status-10分以上';
                case '30分以上': return 'status-30分以上';
                case '売り切れ・終了': return 'status-売り切れ・終了';
                default: return '';
            }
        }


        document.addEventListener('DOMContentLoaded', startSlideshow);
    </script>
</body>
</html>
